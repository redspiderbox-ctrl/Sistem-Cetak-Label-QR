<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak Label Part Landscape (QR Code)</title>
    
    <!-- Pustaka Eksternal -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ink: '#18181b',
                        muted: '#71717a',
                        accent: '#c2410c',
                        accentDark: '#9a3412',
                        success: '#059669',
                        warning: '#d97706',
                    },
                    fontFamily: {
                        display: ['Space Grotesk', 'sans-serif'],
                        mono: ['IBM Plex Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    
    <style>
        :root {
            --page-width: 297mm;
            --page-height: 210mm;
            --margin-x: 5mm;
            --margin-y: 5mm;
            
            /* Grid Config: 4 Kolom x 12 Baris */
            --cols: 4;
            --rows: 12;
            
            --gap-x: 2mm;
            --gap-y: 1.2mm;
            
            /* UKURAN QR CODE DIPERBESAR */
            --qr-size: 12mm; 
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: #1a1a1a;
            min-height: 100vh;
            color: #18181b;
            position: relative;
            overflow-x: hidden;
        }
        
        .bg-grid {
            position: fixed; inset: 0;
            background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 40px 40px; z-index: 0;
        }
        
        .bg-gradient {
            position: fixed; inset: 0;
            background: radial-gradient(ellipse 60% 40% at 50% 0%, rgba(194, 65, 12, 0.15), transparent), radial-gradient(ellipse 40% 30% at 100% 100%, rgba(217, 119, 6, 0.1), transparent);
            z-index: 0;
        }
        
        .a4-paper {
            width: var(--page-width);
            height: var(--page-height);
            max-width: 100%;
            aspect-ratio: 297 / 210;
            background: #ffffff;
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.05), 0 25px 100px -20px rgba(0, 0, 0, 0.5);
            margin: 20px 0;
            padding: var(--margin-y) var(--margin-x);
            position: relative;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .a4-paper::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, #c2410c, #d97706, #c2410c);
        }
        
        /* GRID SYSTEM: 4 Cols x 12 Rows */
        .labels-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(12, 1fr);
            gap: var(--gap-y) var(--gap-x);
            height: 100%;
        }

        .label-card {
            border: 1px solid #27272a;
            border-radius: 2px;
            width: 100%;
            height: 100%;
            position: relative;
            background: #ffffff;
            transition: all 0.2s ease;
            display: flex; align-items: center;
            overflow: hidden;
        }
        
        .label-card:hover {
            box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(194, 65, 12, 0.3);
            z-index: 10;
            background: #fffaf0;
        }

        .label-content { display: flex; width: 100%; height: 100%; align-items: center; padding: 1mm; }
        
        .qr-section {
            width: var(--qr-size);
            height: var(--qr-size);
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            background: #fff; border: 0.5px solid #e4e4e7; border-radius: 1px; padding: 0.2mm;
        }
        
        .qr-section img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }

        .text-section {
            flex-grow: 1; padding: 0 2mm;
            display: flex; flex-direction: column; justify-content: center;
            border-left: 1px solid #e4e4e7; margin-left: 1.5mm; height: 100%;
            overflow: hidden; white-space: nowrap;
        }
        
        .upload-zone {
            position: relative; overflow: hidden;
            background: linear-gradient(135deg, #fafaf9 0%, #f4f4f5 100%);
            border: 2px dashed #a1a1aa;
            transition: all 0.3s ease;
        }
        
        .upload-zone:hover { border-color: #c2410c; background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); }
        .upload-zone.dragover { border-color: #c2410c; background: #ffedd5; transform: scale(1.01); }

        .btn-primary { background: linear-gradient(135deg, #c2410c 0%, #9a3412 100%); transition: all 0.3s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px -10px rgba(194, 65, 12, 0.5); }

        .toast { animation: toastSlide 0.4s ease; }
        @keyframes toastSlide { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .label-card { opacity: 0; animation: labelFade 0.3s ease forwards; }
        @keyframes labelFade { from { opacity: 0; } to { opacity: 1; } }
        
        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .a4-paper { box-shadow: none; margin: 0; padding: var(--margin-y) var(--margin-x); width: 297mm; height: 210mm; }
            .a4-paper::before { display: none; }
        }
        
        @media (max-width: 900px) {
            .a4-paper { transform: scale(0.55); transform-origin: top center; margin-bottom: -450px; }
        }
    </style>
</head>
<body class="flex flex-col items-center p-4 md:p-8 relative">
    
    <div class="bg-grid"></div>
    <div class="bg-gradient"></div>
    
    <!-- Header UI -->
    <header class="no-print w-full max-w-4xl mb-6 relative z-10">
        <div class="bg-stone-900/80 backdrop-blur border border-stone-700 rounded-xl p-4 shadow-2xl">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-accent to-accentDark rounded-lg flex items-center justify-center shadow-lg">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="font-display text-lg font-bold text-white tracking-tight">Label Generator</h1>
                        <p class="text-xs text-stone-400">Layout: 4 Kolom x 12 Baris (QR Besar)</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 text-xs text-stone-300 bg-stone-800 px-3 py-1.5 rounded-full border border-stone-700">
                    <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
                    Siap Cetak
                </div>
            </div>
        </div>
    </header>

    <!-- Control Section -->
    <section class="no-print w-full max-w-4xl mb-6 relative z-10">
        <div class="flex flex-col sm:flex-row gap-4">
            <div class="upload-zone flex-1 rounded-xl p-6 text-center cursor-pointer" id="upload-zone">
                <input type="file" id="file-input-1" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                <div class="pointer-events-none relative z-1">
                    <svg class="w-8 h-8 mx-auto mb-2 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    <strong class="block text-sm font-semibold text-ink">Upload Excel</strong>
                    <p class="text-xs text-muted mt-1">Kolom: Part, Deskripsi, Qty</p>
                </div>
            </div>
            
            <div class="flex flex-col gap-2 justify-center min-w-[140px]">
                <button id="btn-clear-1" class="hidden px-4 py-2 bg-white border border-stone-300 rounded-lg font-semibold text-xs hover:bg-stone-50 transition-all" onclick="clearData()">
                    Reset
                </button>
                <button id="btn-download-1" disabled class="btn-primary px-4 py-3 text-white rounded-lg font-semibold text-sm disabled:opacity-40" onclick="generatePDF()">
                    Download PDF
                </button>
            </div>
        </div>
        <div class="flex justify-between items-center mt-3 text-xs text-stone-400">
             <span id="label-count-1">0 Label</span>
             <span>Ukuran Kertas: A4 Landscape</span>
        </div>
    </section>
    
    <!-- Preview Area -->
    <div class="a4-paper relative z-10 overflow-hidden">
        <div class="labels-container" id="labels-container-1">
            <div class="col-span-full row-span-full flex items-center justify-center h-full text-muted text-sm border-2 border-dashed border-stone-200 rounded-lg">
                <div class="text-center p-4">
                    <svg class="w-10 h-10 mx-auto mb-2 text-stone-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Upload file Excel untuk melihat pratinjau<br>
                    <span class="text-stone-400">(Max 48 label per halaman)</span>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-3"></div>

<script>
    // === STATE ===
    let labelsToPrint = [];
    
    // === PDF CONFIG (4 Cols x 12 Rows) ===
    const PDF_CFG = {
        orientation: 'l', 
        unit: 'mm',
        format: 'a4',
        pageWidth: 297,
        pageHeight: 210,
        marginX: 5,
        marginY: 5,
        cols: 4,
        rows: 12,
        gapX: 2,
        gapY: 1.2,
        qrSize: 12,          // UKURAN QR DIPERBESAR (dari 10 ke 12)
        fontSizePart: 9,
        fontSizeDesc: 5.5
    };
    
    // === FILE HANDLING ===
    document.getElementById('file-input-1').addEventListener('change', (e) => {
        if (e.target.files.length) handleFile(e.target.files[0]);
    });
    
    const uploadZone = document.getElementById('upload-zone');
    uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault(); uploadZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });

    function handleFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const workbook = XLSX.read(e.target.result, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
                if (json.length === 0) throw new Error("File kosong");
                processData(json);
                showToast(`Berhasil memuat ${json.length} baris data`, 'success');
            } catch (err) {
                showToast('Gagal membaca file: ' + err.message, 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    function processData(json) {
        const data = json.map((row, idx) => {
            const findKey = (keys) => {
                const k = Object.keys(row).find(key => keys.includes(key.toLowerCase().trim()));
                return k ? row[k] : "";
            };
            return {
                id: idx,
                part: findKey(['part', 'part number', 'kode', 'code', 'id', 'pn']) || 'N/A',
                desc: findKey(['deskripsi', 'description', 'desc', 'nama', 'name']) || '-',
                qty: findKey(['qty', 'quantity', 'jumlah', 'stock']) || '1'
            };
        });
        
        const labels = [];
        data.forEach(item => {
            let q = parseInt(item.qty);
            if (isNaN(q) || q < 1) q = 1;
            for (let i = 0; i < q; i++) labels.push({ ...item });
        });
        
        labelsToPrint = labels;
        renderLabels();
    }
    
    function clearData() {
        labelsToPrint = [];
        document.getElementById('file-input-1').value = '';
        renderLabels();
        showToast('Data direset', 'success');
    }
    
    // === RENDER LABELS ===
    function renderLabels() {
        const container = document.getElementById('labels-container-1');
        const countBadge = document.getElementById('label-count-1');
        const btnClear = document.getElementById('btn-clear-1');
        const btnDownload = document.getElementById('btn-download-1');
        
        if (labelsToPrint.length === 0) {
            container.innerHTML = `<div class="col-span-full row-span-full flex items-center justify-center h-full text-muted text-sm border-2 border-dashed border-stone-200 rounded-lg"><div class="text-center p-4"><svg class="w-10 h-10 mx-auto mb-2 text-stone-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Upload file Excel untuk melihat pratinjau</div></div>`;
            btnDownload.disabled = true;
            btnClear.classList.add('hidden');
            countBadge.textContent = '0 Label';
            return;
        }
        
        btnDownload.disabled = false;
        btnClear.classList.remove('hidden');
        countBadge.textContent = `${labelsToPrint.length} Label`;
        
        container.innerHTML = '';
        
        const displayLimit = 48; 
        const dataToRender = labelsToPrint.slice(0, displayLimit);
        
        dataToRender.forEach((item, index) => {
            const el = document.createElement('div');
            el.className = 'label-card';
            el.style.animationDelay = `${index * 15}ms`;
            el.innerHTML = `
                <div class="label-content">
                    <div class="qr-section"><img src="${generateQRDataURL(item.part, 3)}" alt="QR"></div>
                    <div class="text-section">
                        <div class="font-mono font-bold text-[11px] text-ink truncate leading-tight">${escapeHtml(item.part)}</div>
                        <div class="text-[6px] text-muted truncate mt-0.5 leading-tight">${escapeHtml(item.desc)}</div>
                    </div>
                </div>`;
            container.appendChild(el);
        });
        
        if (labelsToPrint.length > displayLimit) {
            showToast(`Menampilkan 48 dari ${labelsToPrint.length} label. Download PDF untuk semua.`, 'info');
        }
    }
    
    // === GENERATE PDF ===
    function generatePDF() {
        if (!labelsToPrint.length) return;
        showToast('Membuat PDF...', 'info');
        
        setTimeout(() => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ 
                orientation: PDF_CFG.orientation, 
                unit: PDF_CFG.unit, 
                format: PDF_CFG.format 
            });
            
            const cfg = PDF_CFG;
            
            // Calculate dimensions
            const usableW = cfg.pageWidth - (2 * cfg.marginX);
            const usableH = cfg.pageHeight - (2 * cfg.marginY);
            
            const labelW = (usableW - ((cfg.cols - 1) * cfg.gapX)) / cfg.cols;
            const labelH = (usableH - ((cfg.rows - 1) * cfg.gapY)) / cfg.rows;
            
            let colIdx = 0;
            let rowIdx = 0;

            labelsToPrint.forEach((item, i) => {
                if (rowIdx >= cfg.rows) {
                    doc.addPage();
                    rowIdx = 0;
                    colIdx = 0;
                }
                
                const x = cfg.marginX + (colIdx * (labelW + cfg.gapX));
                const y = cfg.marginY + (rowIdx * (labelH + cfg.gapY));
                
                // Draw Border
                doc.setDrawColor(0);
                doc.setLineWidth(0.2);
                doc.rect(x, y, labelW, labelH);
                
                // Draw QR (LOGIC DISESUAIKAN)
                const qr = qrcode(0, 'L');
                qr.addData(item.part);
                qr.make();
                
                const moduleCount = qr.getModuleCount();
                const cellSize = cfg.qrSize / moduleCount;
                const qrX = x + 1.5;
                const qrY = y + (labelH - cfg.qrSize) / 2; // Centering QR Vertically
                
                doc.setFillColor(0, 0, 0);
                for (let r = 0; r < moduleCount; r++) {
                    for (let c = 0; c < moduleCount; c++) {
                        if (qr.isDark(r, c)) {
                            doc.rect(qrX + c * cellSize, qrY + r * cellSize, cellSize, cellSize, 'F');
                        }
                    }
                }
                
                // Divider Line
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.1);
                doc.line(x + cfg.qrSize + 2.5, y + 1, x + cfg.qrSize + 2.5, y + labelH - 1);
                
                // Text Part Number
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(cfg.fontSizePart); 
                doc.setTextColor(0);
                doc.text(item.part, x + cfg.qrSize + 4, y + labelH/2 - 0.5);
                
                // Text Description
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(cfg.fontSizeDesc); 
                doc.setTextColor(100);
                doc.text(item.desc.substring(0, 50), x + cfg.qrSize + 4, y + labelH/2 + 2);
                
                colIdx++;
                if (colIdx >= cfg.cols) {
                    colIdx = 0;
                    rowIdx++;
                }
            });
            
            doc.save(`Label_4x12_${new Date().toISOString().slice(0, 10)}.pdf`);
            showToast('PDF berhasil dibuat!', 'success');
        }, 100);
    }
    
    // === UTILITIES ===
    function generateQRDataURL(text, size) {
        const qr = qrcode(0, 'L');
        qr.addData(text);
        qr.make();
        return qr.createDataURL(size, 0);
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }
    
    function showToast(msg, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const colors = { success: 'bg-emerald-600', error: 'bg-red-600', info: 'bg-stone-800' };
        toast.className = `toast ${colors[type]} text-white px-4 py-2 rounded shadow-lg text-sm flex items-center gap-2`;
        toast.innerHTML = `<span>${msg}</span>`;
        container.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
    }
</script>

</body>
</html>
