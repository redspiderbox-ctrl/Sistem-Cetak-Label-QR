<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak Label Part (QR Code)</title>
    
    <!-- Pustaka Eksternal -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Pustaka QR Code -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        surface: '#fafaf9',
                        paper: '#ffffff',
                        ink: '#1c1917',
                        muted: '#78716c',
                        accent: '#dc2626',
                        accentDark: '#991b1b',
                        border: '#a8a29e',
                        borderLight: '#e7e5e4',
                        success: '#16a34a',
                        warning: '#ca8a04',
                    },
                    fontFamily: {
                        display: ['Space Grotesk', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    
    <style>
        :root {
            --label-width: 47mm;
            --label-height: 14mm;
            --gap-x: 4mm;
            --gap-y: 8mm;
            --margin-x: 5mm;
            --margin-y: 10mm;
            --qr-size: 10mm;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: linear-gradient(135deg, #292524 0%, #1c1917 50%, #0c0a09 100%);
            min-height: 100vh;
            color: #1c1917;
        }
        
        body::before {
            content: '';
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            opacity: 0.03; pointer-events: none; z-index: 0;
        }
        
        .orb {
            position: fixed; border-radius: 50%; filter: blur(80px); opacity: 0.15; pointer-events: none; z-index: 0;
        }
        .orb-1 { width: 400px; height: 400px; background: #dc2626; top: -100px; right: -100px; animation: float 20s ease-in-out infinite; }
        .orb-2 { width: 300px; height: 300px; background: #f59e0b; bottom: -50px; left: -50px; animation: float 25s ease-in-out infinite reverse; }
        
        @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -30px) scale(1.05); } 66% { transform: translate(-20px, 20px) scale(0.95); } }
        
        .a4-paper {
            width: 210mm; max-width: 100%; min-height: 297mm;
            background: #ffffff;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
            margin: 20px 0; padding: 10mm; position: relative; border-radius: 2px;
        }
        
        .label-card {
            border: 2px solid #1c1917; border-radius: 1px;
            aspect-ratio: 47 / 14;
            position: relative; background: #ffffff;
            transition: all 0.2s ease;
            display: flex; align-items: center;
            overflow: hidden;
        }
        .label-card:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); transform: translateY(-1px); }

        .label-content {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: center;
        }
        
        .qr-section {
            width: 10mm;
            height: 10mm;
            flex-shrink: 0;
            margin-left: 2mm;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
        }
        
        .qr-section img, .qr-section canvas {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        .text-section {
            flex-grow: 1;
            padding: 0 2mm;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-left: 1px solid #e7e5e4;
            margin-left: 2mm;
            height: 100%;
        }
        
        .upload-area { position: relative; overflow: hidden; }
        .upload-area::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(220, 38, 38, 0.1), transparent);
            transition: left 0.5s ease;
        }
        .upload-area:hover::before { left: 100%; }
        
        .toast { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .label-card { opacity: 0; animation: fadeUp 0.4s ease forwards; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e7e5e4; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #78716c; }
        
        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .a4-paper { box-shadow: none; margin: 0; }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important; animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body class="flex justify-center p-4 md:p-8 relative">
    
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    
    <div class="a4-paper relative z-10">
        <div class="max-w-full mx-auto">
            
            <header class="no-print bg-stone-50 border-2 border-stone-400 rounded p-4 mb-4">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                    <div>
                        <h1 class="font-display text-xl font-bold text-ink tracking-tight">Sistem Cetak Label Part</h1>
                        <p class="text-sm text-muted mt-1">Multi-upload dengan layout A4 & QR Code</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-stone-200 rounded text-xs font-mono text-muted">
                            <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
                            Siap
                        </span>
                    </div>
                </div>
            </header>
            
            <!-- Control Section -->
            <section class="no-print controls bg-stone-50 border-2 border-stone-300 rounded p-4 mb-4">
                <div class="flex flex-col lg:flex-row gap-4">
                    <div class="upload-area flex-1 border-2 border-dashed border-stone-400 rounded-lg p-6 text-center cursor-pointer transition-all hover:border-accent hover:bg-red-50">
                        <input type="file" id="file-input-1" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div class="text-3xl mb-2">
                            <svg class="w-8 h-8 mx-auto text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                        </div>
                        <strong class="block text-sm font-semibold text-ink">Upload Excel</strong>
                        <p class="text-xs text-muted mt-1">Kolom: Part, Deskripsi, Qty</p>
                        <p class="text-xs text-accent font-medium mt-1">QR Code dari Part Number</p>
                    </div>
                    <div class="flex flex-col gap-2 justify-center">
                        <button id="btn-clear-1" class="hidden px-4 py-2 bg-white border-2 border-stone-300 rounded font-semibold text-sm hover:bg-stone-100 transition-all" onclick="clearData()">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                                Reset
                            </span>
                        </button>
                        <button id="btn-download-1" disabled class="px-4 py-2 bg-accent text-white rounded font-semibold text-sm hover:bg-accentDark transition-all disabled:opacity-50 disabled:cursor-not-allowed" onclick="generatePDF()">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Download PDF
                            </span>
                        </button>
                    </div>
                </div>
            </section>
            
            <div class="flex justify-between items-center mb-3 no-print">
                <h3 class="font-semibold text-sm text-ink">Pratinjau Label (QR Code)</h3>
                <span id="label-count-1" class="px-3 py-1 bg-stone-100 rounded-full text-xs font-mono text-muted">0 Label</span>
            </div>
            
            <div class="labels-grid grid grid-cols-4 gap-[4mm]" id="labels-container-1">
                <div class="col-span-4 text-center py-8 text-muted border-2 border-dashed border-stone-300 rounded text-sm">
                    Upload file Excel untuk melihat pratinjau
                </div>
            </div>
            
        </div>
    </div>
    
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

<script>
    // === STATE ===
    let labelsToPrint = [];
    
    // === PDF CONFIG ===
    const PDF_CFG = {
        w: 47,
        h: 14,
        marginX: 5,
        marginY: 10,
        gapX: 4,
        gapY: 8,
        qrSize: 10
    };
    
    // === FILE HANDLING ===
    document.getElementById('file-input-1').addEventListener('change', (e) => {
        if (e.target.files.length) handleFile(e.target.files[0]);
    });
    
    function handleFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const workbook = XLSX.read(e.target.result, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
                
                if (json.length === 0) throw new Error("File kosong");
                
                processData(json);
                showToast(`Berhasil memuat ${json.length} baris data`, 'success');
            } catch (err) {
                showToast('Gagal membaca file: ' + err.message, 'error');
                console.error(err);
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    function processData(json) {
        const data = json.map((row, idx) => {
            const findKey = (keys) => {
                const k = Object.keys(row).find(key => keys.includes(key.toLowerCase().trim()));
                return k ? row[k] : "";
            };
            return {
                id: idx,
                part: findKey(['part', 'part number', 'kode', 'code', 'id', 'pn']) || 'N/A',
                desc: findKey(['deskripsi', 'description', 'desc', 'nama', 'name']) || '-',
                qty: findKey(['qty', 'quantity', 'jumlah', 'stock']) || '1'
            };
        });
        
        const labels = [];
        
        data.forEach(item => {
            let q = parseInt(item.qty);
            if (isNaN(q) || q < 1) q = 1;
            
            // Gandakan sesuai Qty
            for (let i = 0; i < q; i++) {
                labels.push({ ...item });
            }
        });
        
        labelsToPrint = labels;
        renderLabels();
    }
    
    function clearData() {
        labelsToPrint = [];
        document.getElementById('file-input-1').value = '';
        renderLabels();
        showToast('Data telah direset', 'success');
    }
    
    // === QR CODE HELPER ===
    function generateQRDataURL(text, size) {
        const qr = qrcode(0, 'L');
        qr.addData(text);
        qr.make();
        return qr.createDataURL(size, 0);
    }
    
    // === RENDER LABELS ===
    function renderLabels() {
        const container = document.getElementById('labels-container-1');
        const countBadge = document.getElementById('label-count-1');
        const btnClear = document.getElementById('btn-clear-1');
        const btnDownload = document.getElementById('btn-download-1');
        
        if (labelsToPrint.length === 0) {
            container.innerHTML = `
                <div class="col-span-4 text-center py-8 text-muted border-2 border-dashed border-stone-300 rounded text-sm">
                    Upload file Excel untuk melihat pratinjau
                </div>`;
            btnDownload.disabled = true;
            btnClear.classList.add('hidden');
            countBadge.textContent = '0 Label';
            return;
        }
        
        btnDownload.disabled = false;
        btnClear.classList.remove('hidden');
        countBadge.textContent = `${labelsToPrint.length} Label`;
        
        const limit = 96;
        const dataToRender = labelsToPrint.slice(0, limit);
        
        container.innerHTML = '';
        
        dataToRender.forEach((item, index) => {
            const el = document.createElement('div');
            el.className = 'label-card';
            el.style.animationDelay = `${index * 20}ms`;
            
            const qrURL = generateQRDataURL(item.part, 2);
            
            el.innerHTML = `
                <div class="label-content">
                    <div class="qr-section">
                        <img src="${qrURL}" alt="QR">
                    </div>
                    <div class="text-section">
                        <div class="font-mono font-bold text-[10px] text-ink truncate leading-tight">${escapeHtml(item.part)}</div>
                        <div class="text-[7px] text-muted truncate leading-tight mt-0.5">${escapeHtml(item.desc)}</div>
                    </div>
                </div>
            `;
            
            container.appendChild(el);
        });
        
        if (labelsToPrint.length > limit) {
            const warning = document.createElement('div');
            warning.className = 'col-span-4 text-center py-4 text-warning text-sm font-medium';
            warning.textContent = `Menampilkan ${limit} dari ${labelsToPrint.length} label. Download PDF untuk semua label.`;
            container.appendChild(warning);
        }
    }
    
    // === GENERATE PDF ===
    async function generatePDF() {
        if (!labelsToPrint.length) return;
        
        showToast('Membuat PDF...', 'info');
        
        setTimeout(() => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const H = 297;
            const cfg = PDF_CFG;
            
            let x = cfg.marginX;
            let y = cfg.marginY;
            let colIndex = 0;
            const colsPerRow = 4;
            
            labelsToPrint.forEach((item, i) => {
                if (y + cfg.h > H - cfg.marginY) {
                    doc.addPage();
                    y = cfg.marginY;
                    x = cfg.marginX;
                    colIndex = 0;
                }
                
                if (colIndex >= colsPerRow) {
                    y += cfg.h + cfg.gapY;
                    x = cfg.marginX;
                    colIndex = 0;
                    
                    if (y + cfg.h > H - cfg.marginY) {
                        doc.addPage();
                        y = cfg.marginY;
                        x = cfg.marginX;
                    }
                }
                
                // Draw border
                doc.setDrawColor(0);
                doc.setLineWidth(0.5);
                doc.rect(x, y, cfg.w, cfg.h);
                
                // Draw QR
                const qr = qrcode(0, 'L');
                qr.addData(item.part);
                qr.make();
                
                const qrModuleCount = qr.getModuleCount();
                const qrDisplaySize = cfg.qrSize;
                const qrCellSize = qrDisplaySize / qrModuleCount;
                
                const qrX = x + 2;
                const qrY = y + (cfg.h - qrDisplaySize) / 2;
                
                doc.setDrawColor(0);
                doc.setFillColor(0, 0, 0);
                
                for (let row = 0; row < qrModuleCount; row++) {
                    for (let col = 0; col < qrModuleCount; col++) {
                        if (qr.isDark(row, col)) {
                            doc.rect(
                                qrX + col * qrCellSize, 
                                qrY + row * qrCellSize, 
                                qrCellSize, 
                                qrCellSize, 
                                'F'
                            );
                        }
                    }
                }
                
                // Divider line
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.1);
                doc.line(x + cfg.qrSize + 3, y + 2, x + cfg.qrSize + 3, y + cfg.h - 2);
                
                // Part Number Text
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                const textStartX = x + cfg.qrSize + 4;
                const textWidth = cfg.w - cfg.qrSize - 6;
                
                const partLines = doc.splitTextToSize(item.part, textWidth);
                doc.text(partLines[0] || '', textStartX, y + 6);
                
                // Description
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(6);
                doc.setTextColor(100, 100, 100);
                const descLines = doc.splitTextToSize(item.desc, textWidth);
                doc.text(descLines[0] || '', textStartX, y + 10.5);
                
                x += cfg.w + cfg.gapX;
                colIndex++;
            });
            
            const timestamp = new Date().toISOString().slice(0, 10);
            doc.save(`Label_QR_${timestamp}.pdf`);
            showToast('PDF berhasil didownload!', 'success');
            
        }, 100);
    }
    
    // === UTILITIES ===
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function showToast(msg, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        
        const bgColors = {
            success: 'bg-green-600',
            error: 'bg-red-600',
            info: 'bg-stone-800'
        };
        
        toast.className = `toast ${bgColors[type]} text-white px-4 py-3 rounded-lg shadow-lg text-sm font-medium flex items-center gap-2`;
        
        const icons = {
            success: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
            error: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',
            info: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
        };
        
        toast.innerHTML = `${icons[type]}<span>${msg}</span>`;
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            toast.style.transition = 'all 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>

</body>
</html>
